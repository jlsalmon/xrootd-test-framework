<!DOCTYPE html>
<html>
	<head>
		<title>$title</title>
			
		<meta http-equiv="refresh" content="url=http://${hostname}:${HTTPport}" />

		<script type="text/javascript" src="webpage/js/jquery-1.6.2.min.js"></script>
		<script type="text/javascript" src="webpage/js/jquery-ui-1.8.16.custom.min.js"></script>
		<script type="text/javascript" src="webpage/js/jquery.nestedAccordion.js"></script>
		<link rel="stylesheet" type="text/css" href="webpage/css/jquery.css" />
		<link rel="stylesheet" type="text/css" href="webpage/css/main.css" />
		<link rel="stylesheet" type="text/css" href="webpage/css/suite_sessions.css" />
		<script type="text/javascript">
			<!--// --><![CDATA[//><!--

				\$.fn.accordion.defaults.container = false;
				\$(function() {
				     #if $suiteSessions and len($suiteSessions) > 0
				        #set $testSessionsNum = len($suiteSessions)
				        #for $i in range($testSessionsNum):
				             #set $j = $i + 1
				             \$("#acc5${j}").accordion({
				              	wrapper: "div", 
				              });
				        #end for
				     #end if
				});
				
				\$(document).ready(function(){
				    \$("tr.important").hide();
				    
				    \$("a.all").click(function () {
				    	\$("tr.important").hide();
				    	\$("tr.all").show();
					});
					\$("a.important").click(function () {
				    	\$("tr.all").hide();
				    	\$("tr.important").show();
					});
				});
			
			//--><!]]>
		</script>
	</head>
	<body>
		<p>XRootD Testing Framework</p>
		<div id="main">
		
			#include "webpage/main_menu.tmpl"
			
			#set $testSessionsNum = 1 
			#set $testCasesNum = 1
			
			<div class="content">
				<h1>Suite sessions [by date]</h1>
				#if $suiteSessions and len($suiteSessions) > 0 
					#import copy 
					#set $revKeys = copy.copy($suiteSessions.keys()) 
					#set $revKeys =	sorted($revKeys, cmp=lambda x,y: cmp($suiteSessions[$y].initDate, $suiteSessions[$x].initDate)) 
					
					#for $key in $revKeys 
						#set $suiteSess = $suiteSessions[$key] 
						#set $htmlSuiteColor = "111111" 
						
						#if	$runningSuiteUids.has_key($suiteSess.name) 
							#if	$runningSuiteUids[$suiteSess.name] == $suiteSess.uid 
								#set $htmlSuiteColor = "00bb00" 
							#end if 
						#end if 
						
						#if	hasattr($suiteSess,	'failed') and $suiteSess.failed 
							#set $htmlSuiteColor = "ee0000" 
						#end if
						<div id="acc5${testSessionsNum}" class="accordion">
							<h3>
								<a href="#" style="color: #${htmlSuiteColor};">
									${suiteSess.name}
									<span style="font-weight: normal;">
										[initialized at: ${suiteSess.initDate.strftime("%a %d-%m-%Y %H:%M:%S")}]
									</span>
								</a>
							</h3>
							<div class="inner">
								#from string import replace 
								
								#def stageDetailsDiv($div_id, $stage)
									<div id="$div_id" class="stage-details"
										title="Details of test result stage at slave ${stage[3]}">
										<table>
											<tr>
												<td>
													State:
													<span class="state">${stage[0]}</span>
												</td>
											</tr>
											<tr>
												<td>
													Slave:
													<span>${stage[3]}</span>
												</td>
											</tr>
											<tr>
												<td>
													Return code:
													<span>
														${stage[1][2].replace('\n', '<br />')}
													</span>
												</td>
											</tr>
											<tr>
												<td>Log messages: 
																<a href="#" class="all">All messages</a>
																| <a href="#" class="important">Important</a> </td>
											</tr>
											<tr class="all">
												#import re		
												#set $stdout = $stage[1][0].decode('utf-8')	
												#set $important = []				
												
												#for $match in re.finditer(r'\n(.*\[\s*ok\s*\])', $stdout, re.I)
													$important.append(($match.group(1), 'success'))
													#set $stdout = $stdout.replace($match.group(1), '<span class="success">' + $match.group(1) + '</span>')
												#end for
												
												#for $match in re.finditer(r'\n(.*\[\s*failed\s*\])', $stdout, re.I)
													$important.append(($match.group(1), 'error'))
													#set $stdout = $stdout.replace($match.group(1), '<span class="error">' + $match.group(1) + '</span>')
												#end for
												
												#for $match in re.finditer(r'\n(.*error.*)\n', $stdout, re.I)
													$important.append(($match.group(1), 'error'))
													#set $stdout = $stdout.replace($match.group(1), '<span class="error">' + $match.group(1) + '</span>')
												#end for
														
												<td class="stdout">$stdout</td>
											</tr>

											<tr class="important">
												<td>
													#for $m in $important 
														<span class="${m[1]}">$m[0]</span><br />
													#end for
												</td>
											</tr>
											
											#if $stage[1][1]
												<tr>
													<td>stderr</td>
												</tr>
												<tr>
													<td class="stdout">
														${stage[1][1].replace('\n','<br />')}
													</td>
												</tr>
											#end if
										</table>
									</div>
								#end def 
								
								#if $suiteSess.cases and len($suiteSess.cases) > 0 
									#set $iS = 1 
									#set $init_stages=$suiteSess.getTestCaseStages("suite_inited") 
								
									#if $init_stages and len($init_stages)
										<h4>
											<a href="#">
												<span style="font-weight: normal;">Suite initialization</span>
												<span style='font-weight: normal'>[run at: ${suiteSess.initDate.strftime("%H:%M:%S")}]</span>
											</a>
										</h4>
										<div class="inner">
										#for $stage in $init_stages 
											#set $linkclass = "success" 
											
											#if $stage[1][2] != "0": 
												#set $linkclass = "error" 
											#end if
											
											<span>	
												#set $div_id = "%s_ist%s_details" % ($suiteSess.uid, $iS)
												
												#import re
												
												#if not re.search('.*Nothing to.*', $stage[1][0])
													&nbsp;<span>${stage[3]}</span>
													<a class="${linkclass}" href="#" id="${suiteSess.uid}_ist${iS}_button">
														&nbsp;[ i ]
													</a>
												#end if
											</span>
											
											$stageDetailsDiv($div_id, $stage)
											
											<script style="display: none;">
												\$( "#${suiteSess.uid}_ist${iS}_button").click(function() {
													\$('tr.important').hide()
													\$('tr.all').show()
													\$( "#${suiteSess.uid}_ist${iS}_details").dialog({
														height: 900, 
														width: \$(document).width()-50, 
														modal: true
													});
												});
											</script>
											#set $iS += 1 
										#end for
									</div>
									#end if 
									
									#for $tC in $suiteSess.cases.itervalues() 
										#set $stages=$suiteSess.getTestCaseStages($tC.uid)
										
										<h4>
											<a href="#">
												<span style="font-weight: normal;">Test Case</span>
												<i>${tC.name}</i>
												<span style='font-weight: normal'>[run at: ${tC.initDate.strftime("%H:%M:%S")}]
												</span>
											</a>
										</h4>
										<div class="inner">
											#if $stages and len($stages) 
											
												#set $slaveStages = {}
												
												#for $stage in $stages
													#if $slaveStages.has_key($stage[3])
														$slaveStages[$stage[3]].append($stage)
													#else
														#set $slaveStages[$stage[3]] = [$stage]
													#end if
												#end for

												#for $slave, $ss in $slaveStages.items()
													
													#import re
													#if not len(re.findall('.*Nothing to.*', ''.join([$s[1][0] for $s in $ss]))) >= 3
														&nbsp;&nbsp;<span>$slave</span>
													#end if
														#for $stage in $ss
															
															#set $linkclass = "success" 
															#if $stage[1][2] != "0": 
																#set $linkclass = "error" 
															#end if
															
															<span>
																#set $div_id = "%s_st%s_details" % ($tC.uid, $iS)
																<a class="${linkclass}" href="#" id="${tC.uid}_st${iS}_button">
																
																#if not re.search('.*Nothing to.*', $stage[1][0])
																	#if $stage[0].id == 41
																		&nbsp;[ i ]
																	#elif $stage[0].id == 44
																		&nbsp;[ r ]
																	#elif $stage[0].id == 47
																		&nbsp;[ f ]
																	#end if
																#end if
																</a>
															</span>
	
															$stageDetailsDiv($div_id, $stage)
															
															<script style="display: none;">
																\$("#${tC.uid}_st${iS}_button").click(function() {
																	\$('tr.important').hide()
																	\$('tr.all').show()
																	\$( "#${tC.uid}_st${iS}_details" ).dialog({
																		height: 900,
																		width: 1152,
																		modal: true
																	});
																});
															</script>
															#set $iS += 1 
															
														#end for
												#end for
											#end if
										</div>
										#set $testCasesNum += 1 
									#end for 
									
									#set $final_stages=$suiteSess.getTestCaseStages("suite_finalized") 
									
									#if $final_stages and len($final_stages)
										<h4>
											<a href="#">
												<span style="font-weight: normal;">Suite finalization</span>
												<span style='font-weight: normal'>[run at: ${suiteSess.initDate.strftime("%H:%M:%S")}]</span>
											</a>
										</h4>
										<div class="inner">
										#for $stage in $final_stages 
											#set $linkclass = "success" 
											
											#if $stage[1][2] != "0": 
												#set $linkclass = "error" 
											#end if
											
											<span>												
												#set $div_id = "%s_ist%s_details" % ($suiteSess.uid, $iS)
												
												#import re
																
												#if not re.search('.*Nothing to.*', $stage[1][0])
													&nbsp;<span>${stage[3]}</span>
													<a class="${linkclass}" href="#" id="${suiteSess.uid}_ist${iS}_button">
														&nbsp;[ f ]
													</a>
												#end if
											</span>
											
											$stageDetailsDiv($div_id, $stage)
											<script style="display: none;">
												\$( "#${suiteSess.uid}_ist${iS}_button").click(function() {
													\$('tr.important').hide()
													\$('tr.all').show()
													\$( "#${suiteSess.uid}_ist${iS}_details").dialog({
														height: 900, 
														width: 1152, 
														modal: true
													});
												});
											</script>
											#set $iS += 1 
										#end for
									</div>
									#end if 
									
								#else
								<p>No test cases have been run in this session.</p>
								#end if
							</div>
						</div>
						#set $testSessionsNum += 1 
					#end for 
				#end if
			</div>
		</div>
	</body>
</html>